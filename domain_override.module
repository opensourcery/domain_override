<?php
// $Id$

/**
 * @file
 * Module functions for Domain Override.
 */

/**
 * Implementation of hook_help().
 */
function domain_override_help($path, $arg) {
  switch ($path) {
    case 'admin/help#domain_override':
      $help = t('Domain Override allows overriding nodes for a specific domain. For instance, say you have an "About Us" page with company details, and that page is set to "Publish to all affiliates." Now, a site editor for your engineering subdomain thinks that page\'s content should be different when viewed on the engineering subdomain -- he wants to essentially "override" the node for the engineering subdomain. Once given proper permissions, he can click the "Override" tab on the node page; Domain Override will create a copy of the node and modify the domain settings for the original node to exclude the engineering subdomain. It will also assign <em>only</em> the engineering subdomain to the new copy of the node (the override). The engineering editor will then be sent directly to the edit page for the new copy of the "About Us" node that is published only on his domain.');
      break;
  }
  return '<p>'. $help .'</p>';
}

/**
 * Implementation of hook_help().
 */
function domain_override_perm() {
  $perms = array(
    'administer domain override',
    'override any content',
  );

  // Build an override permission per content type
  foreach (array_keys(node_get_types('names')) as $content_type) {
    $perms[] = "override $content_type content";
  }
  return $perms;
}

/**
 * Implementation of hook_menu().
 */
function domain_override_menu() {
  $items = array();

  // Administration page
  $items['admin/build/domain/override'] = array(
    'title' => 'Override settings',
    'description' => 'Configure which content types can be overridden per domain',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('domain_override_settings_form'),
    'access arguments' => array('administer domain override'),
    'file' => 'domain_override.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  // 'Override' node tab
  $items['node/%node/override'] = array(
    'title' => 'Override',
    'description' => 'Override node for the current domain',
    'page callback' => 'domain_override_override_page',
    'page arguments' => array(1),
    'access callback' => 'domain_override_override_access',
    'access arguments' => array(1),
    'weight' => 5,
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Access callback for 'Override' node tab.
 */
function domain_override_override_access($node) {
  global $_domain;
  $type = $node->type;

  // Node must be published to current domain and at least one other domain
  // (or published to all domains via $node->domain_site).
  // Otherwise, overriding it on current domain doesn't make sense.
  $access =
    ($node->domain_site || (isset($node->domains[$_domain['domain_id']]) && count($node->domains) > 1)) &&
    (user_access("override $type content") || user_access('override any content')) &&
    node_access('view', $node) && node_access('create', $type) &&
    filter_access($node->format);

  // Allow other modules to alter $access
  drupal_alter('domain_override_access', $access, $node);
  return $access;
}

/**
 * Page callback for node/%node/override.
 */
function domain_override_override_page($node) {
  global $_domain, $user;

  assert($node->domain_site || isset($node->domains[$_domain->domain_id]));
  // If node was published to all affiliates, we must make sure the individual
  // domains are all listed in $node->domains and remove "unpublish for all"
  if ($node->domain_site) {
    $node->domains = drupal_map_assoc(array_keys(domain_domains()));
    $node->domain_site = FALSE;

    // we just rebuilt domains list, and id 0 (main domain) must be stored as
    // -1 there.
    if (isset($node->domains[0])) {
      unset($node->domains[0]);
      $node->domains[-1] = -1;
    }
  }

  // Unpublish $node for the current domain
  unset($node->domains[$_domain['domain_id']]);
  node_save($node);

  // Clone the node (with inspiration from the node_clone project)
  $original_node = drupal_clone($node);
  $node->nid = NULL;
  $node->vid = NULL;
  $node->tnid = NULL;
  $node->name = $user->name;
  $node->uid = $user->uid;
  $node->created = NULL;
  $node->menu = NULL;
  $node->book['mlid'] = NULL;
  $node->path = NULL;
  $node->files = array();
  $node->title = t('Override for !domain: !title', array('!title' => $node->title, '!domain' => $_domain['subdomain']));

  // new node should be accessible to just one domain
  $node->domains = array($_domain['domain_id'] => $_domain['domain_id']);
  $node->domain_site = FALSE; // All affiliates? No.
  $node->subdomains = array($_domain['domain_id'] => $_domain['sitename']);

  // Allow other modules to alter the new node
  drupal_alter('domain_override_node', $node, $original_node);
  node_save($node);

  drupal_goto("node/{$node->nid}/edit");
}

/**
 * Implementation of hook_form_FORM_ID_alter().
 */
function domain_override_form_alter(&$form, &$form_state) {
  // We must be on a node-add form (not node edit form) of an override-enabled content type
  // we must have gotten a valid nid in GET param, and that node must be same type.
  if (isset($form['type']) && isset($form['#node']) && is_null($form['nid']['#value']) &&
      isset($_GET['override_nid']) && is_numeric($_GET['override_nid']) &&
      in_array($form['type']['#value'], _domain_override_overridable_types()) &&
      ($source_node = node_load((int)$_GET['override_nid'])) && $source_node->type == $form['type']['#value']) {

    //dpm($form);

  }
}

/**
 * Implementation of hook_nodeapi().
 */
function domain_override_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  global $_domain;
  //dpm(array('$node'=>$node,'$op'=>$op,'$a3'=>$a3,'$a4'=>$a4,'$_GET'=>$_GET));
  //dpm(array('domain'=>$_domain));
  switch ($op) {
    case 'presave':
      break;

    case 'save':
      break;
  }
}

/**
 * Determines which content types are currently enabled for overridability.
 * @return
 *   array suitable for a checkboxes form element's options.
 */
function _domain_override_overridable_types() {
  $overridable = array();
  foreach (array_keys(node_get_types('names')) as $type) {
    if (variable_get('domain_override_type_'. $type, FALSE)) {
      $overridable[] = $type;
    }
  }
  return $overridable;
}

